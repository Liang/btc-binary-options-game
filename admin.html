async function resolveRound() {
    const res = await fetch(BTSE_API);
    const data = await res.json();
    const endPrice = parseFloat(data[0].last);
    
    stateRef.once('value', snap => {
        const startPrice = snap.val().startPrice;
        const result = endPrice >= startPrice ? 'up' : 'down';
        let addedToJackpot = 0;

        tablesRef.once('value', tSnap => {
            const tables = tSnap.val() || {};
            let survivors = [];

            Object.keys(tables).forEach(id => {
                if(tables[id].status === 'active') {
                    if(tables[id].currentBet !== result) {
                        tablesRef.child(id).update({ status: 'out', currentBet: null });
                        addedToJackpot += 1200;
                    } else {
                        tablesRef.child(id).update({ currentBet: null });
                        survivors.push(id);
                    }
                }
            });
            
            const newJackpot = (snap.val().jackpot || 0) + addedToJackpot;
            const updateData = { 
                status: `RESULT: ${result.toUpperCase()}`,
                jackpot: newJackpot
            };

            // Trigger Winner if only 1 remains
            if (survivors.length === 1) {
                updateData.winnerFound = true;
                updateData.winnerId = survivors[0];
                updateData.status = "CHAMPION FOUND!";
            }

            stateRef.update(updateData);
        });
    });
}
