<!DOCTYPE html>
<html>
<head>
    <title>Tournament Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="admin-body">
    <div class="admin-panel">
        <h2 style="color:var(--gold)">MASTER CONTROL</h2>
        <div class="control-group">
            <label>Table Count:</label>
            <input type="number" id="init-count" value="10">
        </div>
        <div class="control-group">
            <label>Round Timer (sec):</label>
            <input type="number" id="round-duration" value="60">
        </div>
        <button onclick="initGame()" class="btn-blue">RESET & SETUP GAME</button>
        <hr>
        <button onclick="startRound()" class="btn-gold">1. START BETTING WINDOW</button>
        <button onclick="autoResolve()" class="btn-green">2. RESOLVE ROUND</button>
        <hr>
        <div style="display:flex; gap:10px;">
            <button onclick="resolveGame('up')" style="background:#00c076; color:black">FORCE UP</button>
            <button onclick="resolveGame('down')" style="background:#df294a; color:white">FORCE DOWN</button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let countdownInterval = null; // Prevent timer conflicts

        function initGame() {
            if(countdownInterval) clearInterval(countdownInterval);
            const count = parseInt(document.getElementById('init-count').value);
            stateRef.set({ tableCount: count, jackpot: 0, status: "READY", winnerFound: false, timer: "--" });
            tablesRef.set({});
            for(let i=1; i<=count; i++) {
                tablesRef.child(i).set({ status: 'active', currentBet: "", claimedBy: null });
            }
            alert("Tournament Initialized");
        }

        async function startRound() {
            if(countdownInterval) clearInterval(countdownInterval);
            
            const price = await fetchBTCPrice();
            const duration = parseInt(document.getElementById('round-duration').value);
            
            stateRef.update({ 
                status: "BETS OPEN", 
                startPrice: price, 
                timer: duration, 
                winnerFound: false 
            });

            let t = duration;
            countdownInterval = setInterval(() => {
                t--;
                stateRef.update({ timer: t });
                if(t <= 0) {
                    clearInterval(countdownInterval);
                    stateRef.update({ status: "BETS LOCKED", timer: "LOCKED" });
                }
            }, 1000);
        }

        async function autoResolve() {
            const price = await fetchBTCPrice();
            stateRef.once('value', s => {
                const res = price >= s.val().startPrice ? 'up' : 'down';
                resolveGame(res);
            });
        }

        function resolveGame(winningDir) {
            stateRef.once('value', snap => {
                const game = snap.val();
                tablesRef.once('value', tSnap => {
                    const tables = tSnap.val();
                    let survivors = [];
                    Object.keys(tables).forEach(id => {
                        if(tables[id].status === 'active') {
                            if(tables[id].currentBet !== winningDir) {
                                tablesRef.child(id).update({ status: 'out', currentBet: "" });
                            } else {
                                tablesRef.child(id).update({ currentBet: "" });
                                survivors.push(id);
                            }
                        }
                    });
                    const isWin = survivors.length === 1;
                    const jackpot = isWin ? (game.tableCount * BUY_IN) : (game.tableCount - survivors.length) * BUY_IN;
                    stateRef.update({ status: `RESULT: ${winningDir.toUpperCase()}`, jackpot: jackpot, winnerFound: isWin, winnerId: isWin ? survivors[0] : null });
                });
            });
        }
    </script>
</body>
</html>
