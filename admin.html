<!DOCTYPE html>
<html>
<head>
    <title>ADMIN COMMAND</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="admin-body">
    <div class="admin-panel">
        <h1>TOURNAMENT CONTROL</h1>
        <div class="control-group">
            <input type="number" id="init-count" value="10" placeholder="Table Count">
            <button onclick="initGame()" class="btn-blue">INITIALIZE TOURNAMENT</button>
        </div>
        
        <div class="action-buttons">
            <button onclick="startRound()" class="btn-gold">1. START 60s BETTING</button>
            <button onclick="resolveGame('up')" class="btn-green">SIMULATE WIN: UP</button>
            <button onclick="resolveGame('down')" class="btn-red">SIMULATE WIN: DOWN</button>
            <button onclick="autoResolve()" class="btn-white">RESOLVE VIA REAL PRICE</button>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        function initGame() {
            const count = document.getElementById('init-count').value;
            stateRef.set({
                tableCount: parseInt(count),
                jackpot: 0,
                status: "TOURNAMENT START",
                winnerFound: false,
                timer: "--"
            });
            tablesRef.set({});
            for(let i=1; i<=count; i++) {
                tablesRef.child(i).set({ status: 'active', currentBet: "" });
            }
        }

        async function startRound() {
            const price = await fetchBTCPrice();
            stateRef.update({ status: "BETS OPENING", startPrice: price, timer: 60 });
            let t = 60;
            let itv = setInterval(() => {
                t--;
                stateRef.update({ timer: t, status: "ACCEPTING BETS" });
                if(t<=0) { clearInterval(itv); stateRef.update({ status: "BETS LOCKED", timer: "CLOSED" }); }
            }, 1000);
        }

        async function autoResolve() {
            const price = await fetchBTCPrice();
            stateRef.once('value', s => {
                const res = price >= s.val().startPrice ? 'up' : 'down';
                resolveGame(res);
            });
        }

        function resolveGame(winningDir) {
            stateRef.once('value', snap => {
                const game = snap.val();
                tablesRef.once('value', tSnap => {
                    const tables = tSnap.val();
                    let survivors = [];

                    Object.keys(tables).forEach(id => {
                        if(tables[id].status === 'active') {
                            // If table didn't bet, simulate one for stability during demo
                            let bet = tables[id].currentBet || (Math.random() > 0.5 ? 'up' : 'down');
                            if(bet !== winningDir) {
                                tablesRef.child(id).update({ status: 'out', currentBet: "" });
                            } else {
                                tablesRef.child(id).update({ currentBet: "" });
                                survivors.push(id);
                            }
                        }
                    });

                    let win = (survivors.length === 1);
                    // Jackpot = (Total Tables - Survivors) * 1200. If 1 survivor, they take all.
                    let totalPool = win ? (game.tableCount * BUY_IN) : (game.tableCount - survivors.length) * BUY_IN;

                    stateRef.update({
                        status: `RESULT: ${winningDir.toUpperCase()}`,
                        jackpot: totalPool,
                        winnerFound: win,
                        winnerId: win ? survivors[0] : null
                    });
                });
            });
        }
    </script>
</body>
</html>
