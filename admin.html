<!DOCTYPE html>
<html>
<head>
    <title>Tournament Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body style="padding: 40px; background: #0b0e11;">
    <div class="summary-card" style="max-width: 500px; margin: auto;">
        <h2 style="color:var(--gold)">Tournament Control</h2>
        
        <div style="margin-bottom: 30px;">
            <label>Table Count:</label>
            <input type="number" id="count-input" value="10" style="width: 50px; background: #2b3139; color: white; border: 1px solid #444; padding: 5px;">
            <button class="btn-gold" style="padding: 5px 15px;" onclick="setupTournament()">Set Up</button>
        </div>

        <button class="btn-gold" style="width: 100%; margin-bottom: 10px;" onclick="startBetting()">1. START 60s BETTING</button>
        <button class="btn-gold" style="width: 100%; margin-bottom: 10px; background:#6f42c1; color:white;" onclick="fastForward()">üß™ SIMULATE & RESOLVE</button>
        <button class="btn-gold" style="width: 100%; margin-bottom: 10px; background:var(--green); color:black;" onclick="resolveReal()">2. RESOLVE REAL PRICE</button>
        <button class="btn-gold" style="width: 100%; background:var(--red); color:white;" onclick="resetTournament()">‚ö†Ô∏è FULL HARD RESET</button>
    </div>

    <script src="app.js"></script>
    <script>
        const BUY_IN = 1200;

        function setupTournament() {
            const count = parseInt(document.getElementById('count-input').value);
            // Use .set to completely overwrite old data
            stateRef.set({
                tableCount: count,
                jackpot: 0,
                status: "READY",
                winnerFound: false,
                timer: "--",
                startPrice: 0
            });
            
            tablesRef.set({}); // Wipe tables
            for(let i=1; i<=count; i++) {
                tablesRef.child(i).set({ status: 'active', currentBet: "" });
            }
        }

        async function startBetting() {
            const price = await fetchBTCPrice();
            stateRef.update({ status: "BETS OPEN", timer: 60, startPrice: price, winnerFound: false });
            let t = 60;
            let itv = setInterval(() => {
                t--;
                stateRef.update({ timer: t });
                if(t <= 0) { clearInterval(itv); stateRef.update({ status: "BETS LOCKED" }); }
            }, 1000);
        }

        function fastForward() { processTournamentRound(Math.random() > 0.5 ? 'up' : 'down'); }

        async function resolveReal() {
            const price = await fetchBTCPrice();
            stateRef.once('value', snap => {
                const res = price >= snap.val().startPrice ? 'up' : 'down';
                processTournamentRound(res);
            });
        }

        function processTournamentRound(result) {
            stateRef.once('value', snap => {
                const s = snap.val();
                tablesRef.once('value', tSnap => {
                    const ts = tSnap.val() || {};
                    let survivors = [];
                    Object.keys(ts).forEach(id => {
                        if(ts[id].status === 'active') {
                            let bet = ts[id].currentBet || (Math.random() > 0.5 ? 'up' : 'down');
                            if(bet !== result) {
                                tablesRef.child(id).update({ status: 'out', currentBet: "" });
                            } else {
                                tablesRef.child(id).update({ currentBet: "" });
                                survivors.push(id);
                            }
                        }
                    });

                    let totalPrize = (s.tableCount - survivors.length) * BUY_IN;
                    let win = survivors.length === 1;
                    if(win) totalPrize = s.tableCount * BUY_IN;

                    stateRef.update({ 
                        status: `RESULT: ${result.toUpperCase()}`, 
                        jackpot: totalPrize,
                        winnerFound: win,
                        winnerId: win ? survivors[0] : null
                    });
                });
            });
        }

        function resetTournament() {
            if(confirm("THIS WILL WIPE EVERYTHING. ARE YOU SURE?")) {
                setupTournament();
            }
        }
    </script>
</body>
</html>
