<!DOCTYPE html>
<html>
<head>
    <title>BTC BINARY TOURNAMENT</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="projector">
    <div id="winner-overlay" class="hidden">
        <div class="winner-content">
            <h1 class="glow-text">TOURNAMENT CHAMPION</h1>
            <div id="winner-table-name">TABLE XX</div>
            <div id="winner-final-prize">$0,000</div>
        </div>
    </div>

    <header class="game-header">
        <div class="jackpot-container">
            <span class="label">LIVE TOURNAMENT JACKPOT</span>
            <div id="jackpot-value">$0</div>
        </div>
        <div class="status-center">
            <div id="game-status">INITIALIZING...</div>
            <div id="countdown">--</div>
        </div>
        <div class="price-ticker">
            <span class="label">BTC/USD</span>
            <div id="btc-price">------</div>
        </div>
    </header>

    <main class="game-container">
        <aside class="stats-sidebar">
            <div class="stat-card">
                <span class="label">ACTIVE</span>
                <span id="count-active" class="val-green">0</span>
            </div>
            <div class="stat-card">
                <span class="label">ELIMINATED</span>
                <span id="count-out" class="val-red">0</span>
            </div>
            <div class="log-container" id="game-log">
                <div class="log-entry">Waiting for host...</div>
            </div>
        </aside>

        <section class="action-zone">
            <div class="chart-box">
                <div id="tv-chart"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                <script>
                    new TradingView.widget({"autosize":true,"symbol":"COINBASE:BTCUSD","interval":"1","theme":"dark","style":"2","container_id":"tv-chart","hide_top_toolbar":true});
                </script>
            </div>
            <div id="table-grid" class="grid"></div>
        </section>
    </main>

    <script src="app.js"></script>
    <script>
        let lastJackpot = 0;

        stateRef.on('value', snap => {
            const s = snap.val() || {};
            document.getElementById('jackpot-value').innerText = `$${(s.jackpot || 0).toLocaleString()}`;
            document.getElementById('game-status').innerText = s.status || "READY";
            document.getElementById('countdown').innerText = s.timer || "--";

            if(s.winnerFound) {
                const overlay = document.getElementById('winner-overlay');
                overlay.classList.remove('hidden');
                document.getElementById('winner-table-name').innerText = `TABLE ${s.winnerId}`;
                document.getElementById('winner-final-prize').innerText = `$${s.jackpot.toLocaleString()}`;
                confetti({ particleCount: 400, spread: 100, origin: { y: 0.6 } });
            } else {
                document.getElementById('winner-overlay').classList.add('hidden');
            }
        });

        tablesRef.on('value', snap => {
            const data = snap.val() || {};
            const grid = document.getElementById('table-grid');
            let active = 0, out = 0;

            grid.innerHTML = ''; // Full re-render for stability on reset
            Object.keys(data).sort((a,b) => a-b).forEach(id => {
                const table = data[id];
                const card = document.createElement('div');
                card.className = `table-card ${table.status}`;
                if (table.currentBet) card.classList.add('has-bet');
                
                card.innerHTML = `
                    <div class="table-num">T-${id}</div>
                    <div class="table-bet">${table.currentBet ? table.currentBet.toUpperCase() : ''}</div>
                `;
                grid.appendChild(card);
                table.status === 'active' ? active++ : out++;
            });

            document.getElementById('count-active').innerText = active;
            document.getElementById('count-out').innerText = out;
        });

        setInterval(async () => {
            const p = await fetchBTCPrice();
            if(p) document.getElementById('btc-price').innerText = `$${p.toFixed(2)}`;
        }, 1000);
    </script>
</body>
</html>
