<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BTC Tournament - Live Projector</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <audio id="sfx-jackpot" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div id="winner-screen">
        <h1 style="color: var(--primary-gold); font-size: 4rem; margin:0;">üèÜ CHAMPION FOUND</h1>
        <div id="winner-name" style="font-size: 10rem; color: white;">TABLE X</div>
        <div id="winner-prize" style="font-size: 4rem; color: var(--primary-gold);">WON $12,000</div>
    </div>

    <div class="header">
        <div class="stat-box" style="flex: 2;">
            <div class="stat-label">üî• GRAND JACKPOT üî•</div>
            <div id="jackpot" class="stat-value" style="font-size: 5.5rem;">$0</div>
        </div>
        <div style="text-align: center; flex: 1;">
            <div id="status-msg" style="color: var(--text-muted); font-weight: bold; letter-spacing: 2px;">READY</div>
            <div id="timer" class="stat-value">--</div>
        </div>
        <div class="stat-box" style="flex: 1.5;">
            <div class="stat-label">LIVE BTC PRICE (USD)</div>
            <div id="btc-price" class="stat-value" style="font-size: 3rem;">------</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="summary-panel">
            <h3 style="color: var(--primary-gold); border-bottom: 1px solid #444; padding-bottom: 10px;">TOURNAMENT</h3>
            <div class="summary-stats">
                <div class="summary-item">
                    <span>ACTIVE</span>
                    <span id="active-count" style="color: var(--up-green)">0</span>
                </div>
                <div class="summary-item">
                    <span>ELIMINATED</span>
                    <span id="out-count" style="color: var(--down-red)">0</span>
                </div>
            </div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 20px;">Every table starts with $1,200. <br>Last table standing wins everything!</p>
        </div>

        <div class="content-area">
            <div class="chart-container">
                <div id="tradingview_btc" style="height: 100%;"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                <script type="text/javascript">
                    new TradingView.widget({"autosize": true, "symbol": "BINANCE:BTCUSDT", "interval": "1", "theme": "dark", "container_id": "tradingview_btc", "hide_top_toolbar": true});
                </script>
            </div>
            <div class="grid" id="table-grid"></div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let lastJackpotValue = 0;

        stateRef.on('value', snap => {
            const data = snap.val() || {};
            const count = data.tableCount || 25;
            const grid = document.getElementById('table-grid');
            
            if (grid.children.length !== count) {
                grid.innerHTML = '';
                for(let i=1; i<=count; i++) { 
                    grid.innerHTML += `<div id="card-${i}" class="card">T-${i}<div id="bet-${i}" class="bet-indicator"></div></div>`; 
                }
            }
            
            // Jackpot Logic
            const jackpot = data.jackpot || 0;
            if (jackpot > lastJackpotValue) {
                document.getElementById('sfx-jackpot').play().catch(()=>{});
                lastJackpotValue = jackpot;
            }
            document.getElementById('jackpot').innerText = `$${jackpot.toLocaleString()}`;
            document.getElementById('timer').innerText = data.timer || '--';
            document.getElementById('status-msg').innerText = data.status || "READY";

            if (data.winnerFound) {
                document.getElementById('sfx-win').play().catch(()=>{});
                document.getElementById('winner-screen').style.display = 'flex';
                document.getElementById('winner-name').innerText = `TABLE ${data.winnerId}`;
                document.getElementById('winner-prize').innerText = `WON $${jackpot.toLocaleString()}`;
                confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
            } else { 
                document.getElementById('winner-screen').style.display = 'none'; 
            }
        });

        tablesRef.on('value', snap => {
            const tables = snap.val() || {};
            let active = 0, out = 0;
            Object.keys(tables).forEach(id => {
                const card = document.getElementById(`card-${id}`);
                const betEl = document.getElementById(`bet-${id}`);
                if (card && betEl) {
                    const status = tables[id].status || 'active';
                    card.className = `card ${status} ${tables[id].currentBet ? 'betting' : ''}`;
                    betEl.innerText = tables[id].currentBet ? tables[id].currentBet.toUpperCase() : '';
                    betEl.className = `bet-indicator ${tables[id].currentBet ? 'bet-' + tables[id].currentBet : ''}`;
                    if(status === 'active') active++; else out++;
                }
            });
            document.getElementById('active-count').innerText = active;
            document.getElementById('out-count').innerText = out;
        });

        // FAST 1-SECOND PRICE UPDATE
        setInterval(async () => {
            const price = await fetchBTCPrice();
            if(price) {
                const priceEl = document.getElementById('btc-price');
                priceEl.innerText = `$${price.toFixed(2)}`;
            }
        }, 1000);

        window.addEventListener('click', () => {
            document.getElementById('sfx-jackpot').load();
            document.getElementById('sfx-win').load();
        }, { once: true });
    </script>
</body>
</html>
